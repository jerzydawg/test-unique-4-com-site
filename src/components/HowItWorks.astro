---
import { getSiteName, getKeyword, getDomain, getSiteURL, getDesignDNA, getKeywordId } from '../lib/site-config';
import { getContentVariations, getHowItWorksVariations } from '../lib/city-content-variations';
import { loadKeywordVariations } from '../lib/variations/shared/keyword-loader';
import { getCTAVariation } from '../lib/variations/shared/cta-variations';

const siteName = getSiteName();
const keyword = getKeyword();
const domain = getDomain();
const siteURL = getSiteURL();
const designDNA = getDesignDNA();
const keywordId = getKeywordId();

const content = getContentVariations(domain);
const howItWorks = getHowItWorksVariations(domain, keyword);

// Load keyword-specific H2 variations with error handling
let sectionH2 = { h2: `How to Get ${keyword}` };
try {
  const { getH2Variation } = await loadKeywordVariations(keywordId);
  const result = getH2Variation(domain, 'how-it-works');
  // Ensure result has h2 property
  if (result && result.h2) {
    sectionH2 = result;
  }
} catch (e) {
  console.error('Failed to load keyword variations for HowItWorks:', e);
  // Will use fallback h2 above
}

// Smart keyword formatting - avoid "Get Your my gov phone" grammar issues
const keywordLower = keyword.toLowerCase();
const keywordDisplay = keywordLower.startsWith('my ') || keywordLower.startsWith('your ') || keywordLower.startsWith('a ') || keywordLower.startsWith('the ')
  ? keyword
  : `Your ${keyword}`;
---

<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": `How to Get ${keywordDisplay}`,
  "description": `Step-by-step guide to applying for and receiving your ${keyword.toLowerCase()} through federal assistance programs`,
  "step": [
    {
      "@type": "HowToStep",
      "position": 1,
      "name": howItWorks.schemaSteps[0].name,
      "text": howItWorks.schemaSteps[0].text + " " + howItWorks.step1Timing + ".",
      "url": `${siteURL}/eligibility`
    },
    {
      "@type": "HowToStep",
      "position": 2,
      "name": howItWorks.schemaSteps[1].name,
      "text": howItWorks.schemaSteps[1].text + " " + howItWorks.step2Stat + ".",
      "url": `${siteURL}/apply`
    },
    {
      "@type": "HowToStep",
      "position": 3,
      "name": howItWorks.schemaSteps[2].name,
      "text": howItWorks.schemaSteps[2].text + " " + howItWorks.step3Shipping + ".",
      "url": `${siteURL}/apply`
    }
  ],
  "totalTime": howItWorks.totalTime,
  "estimatedCost": {
    "@type": "MonetaryAmount",
    "currency": "USD",
    "value": "0"
  }
})} />

<section class="py-12 md:py-20 bg-gradient-to-b from-gray-50 to-white">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Single Responsive Section Header - No Duplicates -->
    <div class="text-center mb-8 md:mb-16">
      <h2 class="text-gray-900 text-2xl md:text-4xl lg:text-5xl font-bold mb-3 md:mb-6 ">
        {sectionH2.h2 && sectionH2.h2.includes('3') ? (
          <Fragment set:html={sectionH2.h2.replace(/3/, `<span style="color: ${designDNA.colors.primary};">3</span>`)} />
        ) : (
          <span>{sectionH2.h2 || `How to Get ${keyword}`}</span>
        )}
      </h2>
      <p class="text-gray-900 text-base md:text-xl  max-w-3xl mx-auto">
        {content.footerTagline}<span class="text-gray-900 hidden md:inline">. {content.ctaSubtext}</span>
      </p>
    </div>

    <!-- Mobile Steps Carousel -->
    <div class="md:hidden">
      <div class="relative">
        <!-- Steps Container -->
        <div class="flex snap-x snap-mandatory scrollbar-hide gap-4 pb-4" id="mobile-steps">
          <!-- Step 1 -->
          <div class="flex-none w-[85vw] snap-center">
            <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 relative h-full">
              <h3 class="text-gray-900 text-xl font-bold mb-3 text-center">{howItWorks.step1Title}</h3>
              <p class="text-gray-900 text-sm text-center mb-4 ">
                {howItWorks.step1Description}
                <span class="text-gray-900 font-semibold" style={`color: ${designDNA.colors.primary};`}> {howItWorks.step1Timing}.</span>
              </p>
              
              <!-- Time Indicator -->
              <div class="flex items-center justify-center text-sm text-gray-900">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                </svg>
                <span>{howItWorks.step1Timing}</span>
              </div>
            </div>
          </div>

          <!-- Step 2 - Dynamic -->
          <div class="flex-none w-[85vw] snap-center">
            <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 relative h-full">
              <h3 class="text-gray-900 text-xl font-bold mb-3 text-center">{howItWorks.step2Title}</h3>
              <p class="text-gray-900 text-sm text-center mb-4 ">
                {howItWorks.step2Description}
              </p>
              
              <!-- Success Rate -->
              <div class="flex items-center justify-center text-sm text-gray-900">
                <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span>{howItWorks.step2Stat}</span>
              </div>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="flex-none w-[85vw] snap-center">
            <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 relative h-full">
              <h3 class="text-gray-900 text-xl font-bold mb-3 text-center">{howItWorks.step3Title}</h3>
              <p class="text-gray-900 text-sm text-center mb-4 ">
                {howItWorks.step3Description}
              </p>
              
              <!-- Delivery Info -->
              <div class="flex items-center justify-center text-sm text-gray-900">
                <svg class="w-4 h-4 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                  <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z" />
                </svg>
                <span>{howItWorks.step3Shipping}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile Carousel Indicators -->
        <div class="flex justify-center space-x-2 mt-4 mb-8 text-gray-900">
          <button class="w-2.5 h-2.5 rounded-full carousel-dot active" style={`background-color: ${designDNA.colors.primary};`} data-step="0"></button>
          <button class="w-2.5 h-2.5 bg-gray-300 rounded-full carousel-dot" data-step="1"></button>
          <button class="w-2.5 h-2.5 bg-gray-300 rounded-full carousel-dot" data-step="2"></button>
        </div>
      </div>
    </div>

    <!-- Desktop Steps Grid (hidden on mobile) -->
    <div class="hidden md:grid md:grid-cols-3 gap-6 lg:gap-6 mb-10 md:mb-12">
      <!-- Step 1 -->
      <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 text-center">
        <div class="w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center text-white text-2xl font-bold" style={`background: linear-gradient(135deg, ${designDNA.colors.primary}, ${designDNA.colors.secondary});`}>
          1
        </div>
        <h3 class="text-gray-900 text-xl font-bold mb-3 ">{howItWorks.step1Title}</h3>
        <p class="text-gray-900 mb-4 ">
          {howItWorks.step1Description}
          <span class="text-gray-900 font-semibold" style={`color: ${designDNA.colors.primary};`}> {howItWorks.step1Timing}.</span>
        </p>
        <div class="flex items-center justify-center text-sm text-gray-900">
          <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
          <span>{howItWorks.step1Timing}</span>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 text-center">
        <div class="w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center text-white text-2xl font-bold" style={`background: linear-gradient(135deg, ${designDNA.colors.primary}, ${designDNA.colors.secondary});`}>
          2
        </div>
        <h3 class="text-gray-900 text-xl font-bold mb-3 ">{howItWorks.step2Title}</h3>
        <p class="text-gray-900 mb-4 ">
          {howItWorks.step2Description}
        </p>
        <div class="flex items-center justify-center text-sm text-gray-900">
          <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span>{howItWorks.step2Stat}</span>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 text-center">
        <div class="w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center text-white text-2xl font-bold" style={`background: linear-gradient(135deg, ${designDNA.colors.primary}, ${designDNA.colors.secondary});`}>
          3
        </div>
        <h3 class="text-gray-900 text-xl font-bold mb-3 ">{howItWorks.step3Title}</h3>
        <p class="text-gray-900 mb-4 ">
          {howItWorks.step3Description}
        </p>
        <div class="flex items-center justify-center text-sm text-gray-900">
          <svg class="w-4 h-4 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z" />
          </svg>
          <span>{howItWorks.step3Shipping}</span>
        </div>
      </div>
    </div>

    <!-- Single Responsive CTA - No Duplicates -->
    <div class="text-center">
      <a href="/apply" rel="noopener noreferrer" class="inline-block w-full md:w-auto text-white font-bold py-4 md:py-6 px-6 md:px-12 rounded-2xl text-lg md:text-xl shadow-2xl transform hover:scale-105 active:scale-95 transition-all duration-200 hover:opacity-90" style={`background: ${designDNA.gradients.primary};`}>
        <span class="flex items-center justify-center">
          <span class="md:hidden">{getCTAVariation(domain, 'cta')}</span>
          <span class="hidden md:inline">{getCTAVariation(domain, 'cta-alt')}</span>
          <svg class="w-5 h-5 ml-2 md:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </span>
      </a>
      
      <p class="text-gray-900 text-xs md:text-sm  mt-3 md:mt-6">
        {content.ctaSubtext}
      </p>
    </div>
  </div>
</section>

<script>
  // Mobile carousel functionality
  document.addEventListener('DOMContentLoaded', () => {
    const mobileSteps = document.getElementById('mobile-steps');
    const indicators = document.querySelectorAll('[data-step]');
    
    if (mobileSteps && indicators.length > 0) {
      let currentStep = 0;
      
      // Update indicators - uses CSS variable for dynamic color
      function updateIndicators(index: number) {
        indicators.forEach((indicator, i) => {
          const el = indicator as HTMLElement;
          if (i === index) {
            el.classList.remove('bg-gray-300');
            el.classList.add('active');
            el.style.backgroundColor = 'var(--color-primary)';
          } else {
            el.classList.remove('active');
            el.classList.add('bg-gray-300');
            el.style.backgroundColor = '';
          }
        });
      }
      
      // Handle scroll
      mobileSteps.addEventListener('scroll', () => {
        const scrollPosition = mobileSteps.scrollLeft;
        const firstStep = mobileSteps.querySelector('.flex-none') as HTMLElement;
        if (!firstStep) return;
        const stepWidth = firstStep.offsetWidth + 16; // width + gap
        const newStep = Math.round(scrollPosition / stepWidth);
        
        if (newStep !== currentStep) {
          currentStep = newStep;
          updateIndicators(currentStep);
        }
      });
      
      // Handle indicator clicks
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
          const firstStep = mobileSteps.querySelector('.flex-none') as HTMLElement;
          if (!firstStep) return;
          const stepWidth = firstStep.offsetWidth + 16;
          mobileSteps.scrollTo({
            left: stepWidth * index,
            behavior: 'smooth'
          });
        });
      });
    }
  });
</script>

<style>
  /* Hide scrollbar for mobile carousel */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>
